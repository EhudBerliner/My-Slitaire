<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solitaire Pro PWA</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <link rel="apple-touch-icon" href="logo.jpg">

    <style>
        :root {
            --bg-color: #2e7d32;
            --card-ratio: 1.4;
            --card-width: 13vw;
            --card-height: calc(var(--card-width) * var(--card-ratio));
            --spacing: 8px;
            --text-color: #fff;
            --accent-color: #ffd700;
        }

        @media (min-width: 600px) { :root { --card-width: 80px; } }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden; touch-action: none; height: 100vh;
        }

        header {
            height: 60px; background: rgba(0,0,0,0.3);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; color: var(--text-color);
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .icon-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .version-badge { font-size: 0.65rem; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; cursor: pointer; }

        .side-menu {
            position: fixed; top: 0; right: -280px; width: 260px; height: 100%;
            background: #f4f4f4; color: #333; z-index: 1000;
            transition: transform 0.3s ease; box-shadow: -5px 0 15px rgba(0,0,0,0.2);
        }
        .side-menu.open { transform: translateX(-280px); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; }
        .overlay.active { display: block; }
        .menu-list { list-style: none; padding: 20px; }
        .menu-list li { padding: 15px 0; border-bottom: 1px solid #eee; cursor: pointer; }

        #gameBoard { padding: 10px; max-width: 900px; margin: 0 auto; height: calc(100vh - 60px); }
        .top-row { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .stock-container, .foundations-container { display: flex; gap: var(--spacing); }

        .pile {
            width: var(--card-width); height: var(--card-height);
            border-radius: 6px; border: 1px solid rgba(255,255,255,0.2);
            position: relative; background: rgba(0,0,0,0.1);
        }
        .foundation { display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: rgba(255,255,255,0.2); }

        .tableau-container { display: flex; justify-content: space-between; height: 80vh; }
        .tableau-col { width: var(--card-width); position: relative; min-height: 100%; }

        .card {
            width: var(--card-width); height: var(--card-height);
            background: white; border-radius: 5px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column; padding: 4px;
            font-weight: bold; font-size: 1rem;
        }
        .card.red { color: #d32f2f; }
        .card.black { color: #212121; }
        .card.back {
            background: linear-gradient(135deg, #1976d2 25%, #1565c0 100%);
            border: 2px solid #fff;
        }
        .card.dragging { z-index: 9999 !important; pointer-events: none; transform: scale(1.05); }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <button id="menuBtn" class="icon-btn">â˜°</button>
            <div class="game-info">
                <span>××”×œ×›×™×: <b id="movesDisplay">0</b></span>
                <span>× ×™×§×•×“: <b id="scoreDisplay">0</b></span>
            </div>
        </div>
        <div class="title-block">
            <h1>×¡×•×œ×™×˜×¨</h1>
            <small id="versionDisplay" class="version-badge">v1.0.7</small>
        </div>
    </header>

    <div id="sideMenu" class="side-menu">
        <ul class="menu-list">
            <li onclick="app.game.startNewGame()">ğŸ”„ ××©×—×§ ×—×“×©</li>
            <li onclick="app.game.undo()">â†©ï¸ ×‘×˜×œ ××”×œ×š</li>
            <li onclick="app.closeMenu()">âŒ ×¡×’×•×¨</li>
        </ul>
    </div>
    <div id="overlay" class="overlay"></div>

    <main id="gameBoard">
        <div class="top-row">
            <div class="stock-container">
                <div id="stock" class="pile stock"></div>
                <div id="waste" class="pile waste"></div>
            </div>
            <div class="foundations-container">
                <div id="f-0" class="pile foundation" data-suit="h">â™¥</div>
                <div id="f-1" class="pile foundation" data-suit="d">â™¦</div>
                <div id="f-2" class="pile foundation" data-suit="c">â™£</div>
                <div id="f-3" class="pile foundation" data-suit="s">â™ </div>
            </div>
        </div>
        <div id="tableau" class="tableau-container"></div>
    </main>

    <script>
        class SolitaireGame {
            constructor() {
                this.deck = []; this.stock = []; this.waste = [];
                this.foundations = [[], [], [], []];
                this.tableau = [[], [], [], [], [], [], []];
                this.history = []; this.score = 0; this.moves = 0;
            }

            init() {
                const suits = ['h', 'd', 'c', 's'];
                const values = Array.from({length: 13}, (_, i) => i + 1);
                this.deck = [];
                suits.forEach(s => values.forEach(v => {
                    this.deck.push({ suit: s, value: v, color: (s === 'h' || s === 'd') ? 'red' : 'black', faceUp: false, id: `${s}-${v}` });
                }));
                for (let i = this.deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
                }
                this.deal();
            }

            deal() {
                this.tableau = [[], [], [], [], [], [], []];
                let idx = 0;
                for (let i = 0; i < 7; i++) {
                    for (let j = 0; j <= i; j++) {
                        let card = this.deck[idx++];
                        if (j === i) card.faceUp = true;
                        this.tableau[i].push(card);
                    }
                }
                this.stock = this.deck.slice(idx);
                this.waste = []; this.foundations = [[], [], [], []];
            }

            saveState() {
                this.history.push(JSON.stringify({
                    stock: this.stock, waste: this.waste, foundations: this.foundations,
                    tableau: this.tableau, score: this.score, moves: this.moves
                }));
            }

            isValidMove(card, target, type) {
                if (type === 'foundation') {
                    if (!target) return card.value === 1;
                    return card.suit === target.suit && card.value === target.value + 1;
                }
                if (!target) return card.value === 13;
                return card.color !== target.color && card.value === target.value - 1;
            }
        }

        class UIManager {
            constructor(game) {
                this.game = game;
                this.dragInfo = null;
                this.elTableau = document.getElementById('tableau');
            }

            render() {
                // Stock & Waste
                document.getElementById('stock').innerHTML = this.game.stock.length ? `<div class="card back" onclick="app.drawStock()"></div>` : `<div style="font-size:1.5rem; cursor:pointer;" onclick="app.resetStock()">ğŸ”„</div>`;
                const wasteEl = document.getElementById('waste');
                wasteEl.innerHTML = '';
                if (this.game.waste.length) wasteEl.appendChild(this.createCardEl(this.game.waste[this.game.waste.length - 1]));

                // Foundations
                this.game.foundations.forEach((pile, i) => {
                    const el = document.getElementById(`f-${i}`);
                    el.innerHTML = pile.length ? '' : el.dataset.suit === 'h' ? 'â™¥' : el.dataset.suit === 'd' ? 'â™¦' : el.dataset.suit === 'c' ? 'â™£' : 'â™ ';
                    if (pile.length) {
                        const cardEl = this.createCardEl(pile[pile.length - 1]);
                        cardEl.addEventListener('pointerup', (e) => this.handleDrop(e, 'foundation', i));
                        el.appendChild(cardEl);
                    } else {
                        el.onpointerup = (e) => this.handleDrop(e, 'foundation', i);
                    }
                });

                // Tableau
                this.elTableau.innerHTML = '';
                this.game.tableau.forEach((col, i) => {
                    const colDiv = document.createElement('div');
                    colDiv.className = 'tableau-col';
                    colDiv.addEventListener('pointerup', (e) => this.handleDrop(e, 'tableau', i));
                    
                    let offset = 0;
                    col.forEach((card, ci) => {
                        const cardEl = this.createCardEl(card);
                        cardEl.style.top = `${offset}px`;
                        if (card.faceUp) this.addDragEvents(cardEl, card, i, ci);
                        colDiv.appendChild(cardEl);
                        offset += card.faceUp ? 30 : 15;
                    });
                    this.elTableau.appendChild(colDiv);
                });

                document.getElementById('scoreDisplay').innerText = this.game.score;
                document.getElementById('movesDisplay').innerText = this.game.moves;
            }

            createCardEl(card) {
                const el = document.createElement('div');
                el.className = `card ${card.faceUp ? card.color : 'back'}`;
                if (card.faceUp) {
                    const suitMap = {h:'â™¥', d:'â™¦', c:'â™£', s:'â™ '};
                    const valMap = {1:'A', 11:'J', 12:'Q', 13:'K'};
                    el.innerHTML = `<span>${valMap[card.value] || card.value} ${suitMap[card.suit]}</span>`;
                }
                return el;
            }

            addDragEvents(el, card, colIdx, cardIdx) {
                el.addEventListener('pointerdown', (e) => {
                    e.stopPropagation();
                    const rect = el.getBoundingClientRect();
                    this.dragInfo = { 
                        el, card, colIdx, cardIdx,
                        offsetX: e.clientX - rect.left,
                        offsetY: e.clientY - rect.top
                    };
                    el.classList.add('dragging');
                    el.setPointerCapture(e.pointerId);
                });
                el.addEventListener('pointermove', (e) => {
                    if (!this.dragInfo || this.dragInfo.el !== el) return;
                    const parentRect = el.parentElement.getBoundingClientRect();
                    el.style.left = `${e.clientX - parentRect.left - this.dragInfo.offsetX}px`;
                    el.style.top = `${e.clientY - parentRect.top - this.dragInfo.offsetY}px`;
                });
                el.addEventListener('pointerup', (e) => {
                    if (!this.dragInfo) return;
                    el.classList.remove('dragging');
                    this.dragInfo = null;
                    setTimeout(() => this.render(), 10);
                });
            }

            handleDrop(e, type, idx) {
                if (!this.dragInfo) return;
                app.attemptMove(this.dragInfo, type, idx);
                this.dragInfo = null;
            }
        }

        const game = new SolitaireGame();
        const ui = new UIManager(game);

        const app = {
            start() { 
                game.init(); ui.render(); 
                if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
            },
            drawStock() {
                game.saveState();
                // Draw 3 cards
                for(let i=0; i<3; i++) {
                    if (game.stock.length > 0) {
                        let card = game.stock.pop();
                        card.faceUp = true;
                        game.waste.push(card);
                    }
                }
                ui.render();
            },
            resetStock() {
                game.saveState();
                game.stock = game.waste.reverse().map(c => { c.faceUp = false; return c; });
                game.waste = [];
                ui.render();
            },
            attemptMove(drag, targetType, targetIdx) {
                let targetCol = targetType === 'tableau' ? game.tableau[targetIdx] : game.foundations[targetIdx];
                let targetCard = targetCol.length ? targetCol[targetCol.length - 1] : null;

                if (game.isValidMove(drag.card, targetCard, targetType)) {
                    game.saveState();
                    let cards = (drag.colIdx !== undefined) ? game.tableau[drag.colIdx].splice(drag.cardIdx) : [game.waste.pop()];
                    if (drag.colIdx !== undefined && game.tableau[drag.colIdx].length > 0) {
                        game.tableau[drag.colIdx][game.tableau[drag.colIdx].length - 1].faceUp = true;
                    }
                    targetCol.push(...cards);
                    game.moves++;
                    if (targetType === 'foundation') game.score += 10;
                }
                ui.render();
            },
            game: {
                startNewGame: () => { game.init(); ui.render(); app.closeMenu(); },
                undo: () => { 
                    if (game.history.length) {
                        const state = JSON.parse(game.history.pop());
                        Object.assign(game, state);
                        ui.render();
                    }
                    app.closeMenu();
                }
            },
            closeMenu: () => {
                document.getElementById('sideMenu').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            }
        };

        document.getElementById('menuBtn').onclick = () => {
            document.getElementById('sideMenu').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        };
        document.getElementById('overlay').onclick = app.closeMenu;

        app.start();
    </script>
</body>
</html>
